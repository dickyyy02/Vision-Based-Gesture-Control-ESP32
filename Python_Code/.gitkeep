import cv2
import mediapipe as mp
import serial
import time
import numpy as np

# === ESP32 Serial Setup ===
ESP_PORT = "COM9"
BAUD_RATE = 115200
ser = serial.Serial(ESP_PORT, BAUD_RATE, timeout=0.5)
time.sleep(2)

# === MediaPipe Hands Setup ===
mp_hands = mp.solutions.hands
mp_drawing = mp.solutions.drawing_utils
hands = mp_hands.Hands(
    static_image_mode=False,
    max_num_hands=2,
    min_detection_confidence=0.7,
    min_tracking_confidence=0.6
)

# === Finger indices ===
FINGER_TIPS = [4, 8, 12, 16, 20]
FINGER_BASE = [2, 5, 9, 13, 17]
FINGER_NAMES = ["Thumb", "Index", "Middle", "Ring", "Pinky"]

# === Finger Detection Logic ===
def detect_fingers(hand_landmarks, handedness):
    states = {}

    for i, name in enumerate(FINGER_NAMES):
        tip = hand_landmarks.landmark[FINGER_TIPS[i]]
        base = hand_landmarks.landmark[FINGER_BASE[i]]

        if name == "Thumb":
            if handedness == "Right":
                states[name] = "OPEN" if tip.x < base.x else "CLOSE"
            else:
                states[name] = "OPEN" if tip.x > base.x else "CLOSE"
        else:
            states[name] = "OPEN" if tip.y < base.y else "CLOSE"

    return states

# === Camera Setup ===
cap = cv2.VideoCapture(0)
cap.set(cv2.CAP_PROP_FRAME_WIDTH, 960)
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 720)

last_send_time = time.time()
SEND_INTERVAL = 0.08

print("ðŸ– Finger Detection System Started")

while cap.isOpened():
    ret, frame = cap.read()
    if not ret:
        continue

    frame = cv2.flip(frame, 1)
    rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    try:
        results = hands.process(rgb)
    except:
        continue

    right_hand = None
    left_hand = None

    if results.multi_hand_landmarks and results.multi_handedness:
        for idx, hand_landmarks in enumerate(results.multi_hand_landmarks):
            handedness = results.multi_handedness[idx].classification[0].label
            states = detect_fingers(hand_landmarks, handedness)

            if handedness == "Right":
                right_hand = states
            else:
                left_hand = states

            mp_drawing.draw_landmarks(
                frame,
                hand_landmarks,
                mp_hands.HAND_CONNECTIONS
            )

    display_y = 40
    selected_hand = right_hand if right_hand else left_hand

    if selected_hand:
        for finger, state in selected_hand.items():
            cv2.putText(
                frame,
                f"{finger}: {state}",
                (20, display_y),
                cv2.FONT_HERSHEY_SIMPLEX,
                0.7,
                (0, 255, 0),
                2
            )
            display_y += 30

        if time.time() - last_send_time >= SEND_INTERVAL:
            try:
                packet = ",".join([f"{k}:{v}" for k, v in selected_hand.items()])
                ser.write((packet + "\n").encode())
                last_send_time = time.time()
            except:
                pass

    cv2.imshow("Hand Finger Detection", frame)
    if cv2.waitKey(1) & 0xFF == ord("q"):
        break

cap.release()
cv2.destroyAllWindows()
ser.close()

